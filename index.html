<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sam Christmas Puzzle</title>
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      background:#000;
      color:#fff;
      font-family: Arial, sans-serif;
      text-align:center;
      overflow-x:hidden;
    }

    .section { display:none; padding: 24px 16px; }
    .section.active { display:block; }

    h1,h2 { margin: 8px 0 14px; font-weight: 700; }

    button{
      margin-top: 14px;
      padding: 10px 18px;
      font-size: 16px;
      border: none;
      border-radius: 12px;
      background: #222;
      color: #fff;
      cursor: pointer;
    }
    button:disabled{ opacity: .45; cursor: default; }

    /* ===== Password screens ===== */
    .code-row{
      display:flex;
      justify-content:center;
      gap:10px;
      margin-top: 10px;
    }
    .code-input{
      width: 44px;
      height: 44px;
      font-size: 24px;
      text-align:center;
      border-radius: 10px;
      border: 2px solid #333;
      outline:none;
      background:#111;
      color:#fff;
    }

    /* First password: lowercase, red */
    #pw1 .code-input{
      color:#ff2d2d;
      text-transform: none;
      border-color:#550000;
    }

    /* Second password: normal styling */
    #pw2 .code-input{
      color:#fff;
      text-transform: uppercase;
      border-color:#333;
    }

    /* ===== Puzzle 1 (mouse-move music) ===== */
    #p1{
      position: relative;
      min-height: calc(100vh - 48px);
      padding-top: 24px;
    }
    #p1 .fill{
      position: absolute;
      inset: 0;
      background: #00ff2a;
      transform-origin: left center;
      transform: scaleX(0);
      transition: transform 0.08s linear;
      z-index: 0;
      opacity: .45;
    }
    #p1 .content{
      position: relative;
      z-index: 1;
    }
    #p1 .meter{
      width: min(760px, 92vw);
      height: 14px;
      border-radius: 999px;
      background: #111;
      border: 1px solid #333;
      margin: 16px auto 6px;
      overflow:hidden;
    }
    #p1 .meter > div{
      height: 100%;
      width: 0%;
      background: #00ff2a;
      transition: width .12s linear;
    }
    #p1 .status{
      min-height: 22px;
      opacity:.85;
      margin-top: 6px;
    }

    /* ===== Puzzle 2 + 5 clock shared ===== */
    .clock{
      font-size: 52px;
      letter-spacing: 2px;
      margin: 12px 0 6px;
    }
    .rule-title{
      margin-top: 6px;
      font-size: 22px;
      line-height: 1.1;
    }
    .strike{
      text-decoration: line-through;
      opacity: .7;
      margin-right: 8px;
    }
    .fib{
      color: #ff4df3;
      font-family: "Comic Sans MS", "Comic Sans", cursive;
      font-weight: 700;
      margin-right: 8px;
    }

    /* ===== Monty Hall ===== */
    .doors{
      display:flex;
      justify-content:center;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .door{
      width: 150px;
      height: 210px;
      border-radius: 16px;
      border: 2px solid #444;
      background: #111;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 26px;
      cursor:pointer;
      user-select:none;
      position: relative;
    }
    .door.selected{ outline: 3px solid #00c8ff; }
    .door.revealed{ border-color:#777; opacity:.75; cursor: default; }
    .door .tag{
      position:absolute;
      top: 10px;
      left: 10px;
      font-size: 12px;
      opacity:.75;
    }
    .monty-actions{
      margin-top: 14px;
      display:flex;
      gap: 12px;
      justify-content:center;
      flex-wrap: wrap;
    }
    #monty-msg{ min-height: 48px; margin-top: 10px; opacity:.9; }

    /* Goat counter */
    .goat-wrap{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      margin-top: 10px;
    }
    .goat-pill{
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #333;
      background:#111;
      font-size: 14px;
      opacity:.95;
    }
    .goat-dot{
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.25);
      background: #22c55e;
      display:inline-block;
      vertical-align: middle;
      margin-right: 6px;
    }
    #monty-note{
      margin-top: 8px;
      opacity:.85;
      font-size: 14px;
    }

    /* ===== Crossword ===== */
    .cw-wrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 10px;
    }
    .cw-grid{
      border-collapse: collapse;
      table-layout: fixed;
      margin: 10px auto 6px;
      background:#000;
    }
    .cw-grid td{
      width: 44px;
      height: 44px;
      border: 2px solid #444;
      padding: 0;
      position: relative;
      background:#111;
    }
    .cw-grid td.black{
      background:#000 !important;
    }
    .cw-inp{
      width:100%;
      height:100%;
      border: none;
      outline:none;
      text-align:center;
      font-size: 22px;
      background:#fff;
      color:#000;
      text-transform: uppercase;
      display:block;
    }
    .cw-num{
      position:absolute;
      top: 2px;
      left: 4px;
      font-size: 10px;
      color:#000;
      pointer-events:none;
      z-index:2;
      background: rgba(255,255,255,.55);
      padding: 0 3px;
      border-radius: 6px;
    }
    .clues{
      text-align:left;
      width: min(760px, 92vw);
      margin: 6px auto 0;
      line-height: 1.35;
      border-top: 1px solid #222;
      padding-top: 10px;
      opacity:.95;
    }
    .clues h3{ margin: 8px 0 6px; }
    .clues p{ margin: 4px 0; }

    /* crossword haha */
    #cwHaha{
      color:#ff2d2d;
      font-weight:700;
      margin-top: 6px;
      min-height: 22px;
      opacity: 0;
      transition: opacity .25s ease;
    }
    #cwHaha.show{ opacity: 1; }

    /* Final */
    #final img{
      display:block;
      max-width: min(520px, 80vw);
      max-height: min(70vh, 620px);
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: 18px;
      border: 2px solid #333;
      margin: 12px auto 0;
      background: #000;
    }
    #final .mc{
      margin-top: 14px;
      font-size: 26px;
    }
  </style>
</head>
<body>

  <!-- Global audio (hidden) -->
  <audio id="jingle" preload="auto" src="jinglebells.mp3"></audio>
  <audio id="hahaSound" preload="auto" src="haha.mp3"></audio>

  <!-- ===== Password 1 ===== -->
  <section id="pw1" class="section active">
    <h1>enter password</h1>
    <div class="code-row" aria-label="Password entry">
      <input class="code-input" maxlength="1" id="pw1_1" autocomplete="off" />
      <input class="code-input" maxlength="1" id="pw1_2" autocomplete="off" />
      <input class="code-input" maxlength="1" id="pw1_3" autocomplete="off" />
      <input class="code-input" maxlength="1" id="pw1_4" autocomplete="off" />
    </div>
  </section>

  <!-- ===== Puzzle 1 ===== -->
  <section id="p1" class="section">
    <div class="fill" id="p1Fill"></div>
    <div class="content">
      <h1>Puzzle 1</h1>
      <div class="meter"><div id="p1MeterBar"></div></div>
      <div class="status" id="p1Status"></div>
      <button id="p1Next" disabled>Next</button>
    </div>
  </section>

  <!-- ===== Puzzle 2 ===== -->
  <section id="p2" class="section">
    <h1>Puzzle 2</h1>
    <div class="rule-title">
      <span class="fib">Fibonacci</span><span class="strike">Prime</span>Time
    </div>
    <div class="clock" id="p2Clock">00:00</div>
    <button id="p2Check">Fibonacci Time?</button>
    <button id="p2Next" style="display:none;">Next</button>
  </section>

  <!-- ===== Puzzle 3 ===== -->
  <section id="p3" class="section">
    <h1>Puzzle 3</h1>

    <div id="monty-note">Three goats and you're back to puzzle 1.</div>

    <div class="goat-wrap">
      <div class="goat-pill">
        <span class="goat-dot" id="goatDot"></span>
        Goats: <span id="goatCount">0</span>/3
      </div>
    </div>

    <div class="doors" id="doors"></div>

    <div id="monty-msg"></div>

    <div class="monty-actions">
      <button id="stayBtn" style="display:none;">Stay</button>
      <button id="switchBtn" style="display:none;">Switch</button>
      <button id="retryBtn" style="display:none;">Try again</button>
    </div>

    <button id="p3Next" style="display:none;">Next</button>
  </section>

  <!-- ===== Puzzle 4 ===== -->
  <section id="p4" class="section">
    <h1>Puzzle 4</h1>

    <div class="cw-wrap">
      <table class="cw-grid" id="cwTable"></table>

      <button id="cwCheck">Check</button>
      <div id="cwHaha">haha</div>

      <button id="p4Next" style="display:none;">Next</button>
    </div>

    <div class="clues">
      <h3>Across</h3>
      <p><b>1.</b> With 2 and 3, HEART EFIR RWATE</p>
      <p><b>2.</b> See 1</p>
      <p><b>3.</b> See 1</p>
      <p><b>4.</b> ⏏</p>
      <p><b>7.</b> 0, 1, 3, 6, 2, 7, 13, 20, 12, 21, 11, 22, 10, 23, 9, 24... Re_____'s</p>
      <p><b>8.</b> Almost done with the puzzle?</p>
      <p><b>9.</b> What happens if your mouse stops moving?</p>

      <h3>Down</h3>
      <p><b>1.</b> What 6 does when 2 is over 3</p>
      <p><b>2.</b> S13 JA425</p>
      <p><b>3.</b> Puzzle... it fair?</p>
      <p><b>5.</b> There's only one of you, you're being obnoxious with that S, you should just be a...</p>
      <p><b>6.</b> Only red and white just now, mintier that way</p>
    </div>
  </section>

  <!-- ===== Puzzle 5 ===== -->
  <section id="p5" class="section">
    <h1>Puzzle 5</h1>
    <div class="rule-title">
      <span class="strike">Prime</span><span class="fib">Fibonacci</span><span style="margin-right:8px;">Prime</span>Time
    </div>
    <div class="clock" id="p5Clock">00:00</div>
    <button id="p5Check">Prime Fibonacci Time?</button>
    <button id="p5Next" style="display:none;">Next</button>
  </section>

  <!-- ===== Password 2 ===== -->
  <section id="pw2" class="section">
    <h1>Luke has the final password, you should tell him how much fun you've had with the puzzle and he might give it to you!</h1>
    <div class="code-row" aria-label="Final password entry">
      <input class="code-input" maxlength="1" id="pw2_1" autocomplete="off" />
      <input class="code-input" maxlength="1" id="pw2_2" autocomplete="off" />
      <input class="code-input" maxlength="1" id="pw2_3" autocomplete="off" />
      <input class="code-input" maxlength="1" id="pw2_4" autocomplete="off" />
      <input class="code-input" maxlength="1" id="pw2_5" autocomplete="off" />
      <input class="code-input" maxlength="1" id="pw2_6" autocomplete="off" />
      <input class="code-input" maxlength="1" id="pw2_7" autocomplete="off" />
    </div>
  </section>

  <!-- ===== Final Screen ===== -->
  <section id="final" class="section">
    <h1>Congratulations!</h1>
    <img src="fuecoco.jpg" alt="Fuecoco" />
    <div class="mc">Merry Christmas</div>
  </section>

<script>
  function show(id){
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');

    if (id === 'p1') initPuzzle1();
    if (id === 'p2') initFibTime();
    if (id === 'p3') initMonty();
    if (id === 'p4') initCrossword();
    if (id === 'p5') initPrimeFibTime();

    if (id === 'final') {
      const j = document.getElementById('jingle');
      try {
        j.pause();
        j.currentTime = 0;
        j.loop = true;
        j.play();
      } catch(e) {}
    }
  }

  /* ===== Password 1: haha (lowercase), lock inputs, play full sound, then advance ===== */
  (function initPw1(){
    const inputs = [pw1_1, pw1_2, pw1_3, pw1_4];
    let pw1Done = false;

    inputs.forEach((inp, i) => {
      inp.addEventListener('input', () => {
        if (pw1Done) { inp.value = (inp.value || '').slice(0,1).toLowerCase(); return; }
        inp.value = (inp.value || '').slice(0,1).toLowerCase();
        if (inp.value && i < inputs.length - 1) inputs[i+1].focus();
        check();
      });
      inp.addEventListener('keydown', (e) => {
        if (pw1Done) { e.preventDefault(); return; }
        if (e.key === 'Backspace' && !inp.value && i > 0) inputs[i-1].focus();
      });
    });

    function lockInputs(){
      inputs.forEach(inp => { inp.readOnly = true; inp.blur(); });
    }

    function check(){
      const code = inputs.map(x => (x.value || '')).join('');
      if (code === 'haha' && !pw1Done){
        pw1Done = true;
        lockInputs();

        const s = document.getElementById('hahaSound');
        s.onended = () => { s.onended = null; show('p1'); };
        try { s.currentTime = 0; s.play(); } catch(e) { show('p1'); }
      }
    }
  })();

  /* ===== Puzzle 1: mouse-move audio, complete at 10 seconds ===== */
  let p1Inited = false;
  let p1RAF = null;
  let lastMouseMove = 0;
  let displayProgress = 0;
  let p1Done = false;

  const P1_TARGET_SECONDS = 10;

  function initPuzzle1(){
    const audio = document.getElementById('jingle');
    const nextBtn = document.getElementById('p1Next');
    const status = document.getElementById('p1Status');
    const fill = document.getElementById('p1Fill');
    const meterBar = document.getElementById('p1MeterBar');

    p1Done = false;
    nextBtn.disabled = true;
    status.textContent = '';
    displayProgress = 0;
    fill.style.transform = 'scaleX(0)';
    meterBar.style.width = '0%';

    try { audio.loop = false; audio.pause(); audio.currentTime = 0; } catch(e) {}

    if (!p1Inited){
      p1Inited = true;
      document.addEventListener('mousemove', () => {
        lastMouseMove = performance.now();
      }, { passive: true });

      nextBtn.addEventListener('click', () => show('p2'));
    }

    if (p1RAF) cancelAnimationFrame(p1RAF);

    const MOVE_WINDOW_MS = 220;

    function tick(){
      const now = performance.now();
      const moving = (now - lastMouseMove) <= MOVE_WINDOW_MS;

      if (!p1Done){
        if (moving){
          try { if (audio.paused) audio.play(); } catch(e) {}
        } else {
          if (!audio.paused || audio.currentTime !== 0){
            try { audio.pause(); audio.currentTime = 0; } catch(e) {}
          }
        }
      }

      if (!p1Done && audio.currentTime >= P1_TARGET_SECONDS){
        p1Done = true;
        try { audio.pause(); } catch(e) {}
        nextBtn.disabled = false;
      }

      const target = Math.max(0, Math.min(1, audio.currentTime / P1_TARGET_SECONDS));

      if (!moving && !p1Done){
        displayProgress = Math.max(0, displayProgress - 0.012);
      } else {
        displayProgress = displayProgress + (target - displayProgress) * 0.25;
      }

      fill.style.transform = `scaleX(${displayProgress})`;
      meterBar.style.width = `${Math.round(displayProgress * 100)}%`;

      p1RAF = requestAnimationFrame(tick);
    }

    p1RAF = requestAnimationFrame(tick);
  }

  /* ===== Puzzle 2: TEST MODE — always succeeds ===== */
  let p2Timer = null;
  function initFibTime(){
    const clock = document.getElementById('p2Clock');
    const checkBtn = document.getElementById('p2Check');
    const nextBtn = document.getElementById('p2Next');

    nextBtn.style.display = 'none';

    function update(){
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      clock.textContent = `${hh}:${mm}`;
    }
    update();
    if (p2Timer) clearInterval(p2Timer);
    p2Timer = setInterval(update, 1000);

    checkBtn.onclick = () => {
      nextBtn.style.display = 'inline-block';
    };
    nextBtn.onclick = () => show('p3');
  }

  /* ===== Puzzle 3: Monty Hall (rigged) + goat counter ===== */
  let goatLosses = 0;

  function updateGoatUI(){
    const dot = document.getElementById('goatDot');
    const count = document.getElementById('goatCount');
    count.textContent = String(goatLosses);
    if (goatLosses <= 0) dot.style.background = '#22c55e';
    else if (goatLosses === 1) dot.style.background = '#f59e0b';
    else dot.style.background = '#ef4444';
  }

  function hardReset(){
    show('p1');
  }

  function initMonty(){
    const doorsEl = document.getElementById('doors');
    const msgEl = document.getElementById('monty-msg');
    const stayBtn = document.getElementById('stayBtn');
    const switchBtn = document.getElementById('switchBtn');
    const retryBtn = document.getElementById('retryBtn');
    const nextBtn = document.getElementById('p3Next');

    updateGoatUI();

    doorsEl.innerHTML = '';
    msgEl.textContent = '';
    stayBtn.style.display = 'none';
    switchBtn.style.display = 'none';
    retryBtn.style.display = 'none';
    nextBtn.style.display = 'none';

    const state = { picked:null, carDoor:null, revealed:null, finished:false };

    for (let i=0;i<3;i++){
      const d = document.createElement('div');
      d.className = 'door';
      d.dataset.idx = String(i);
      d.innerHTML = `<div class="tag">Door ${i+1}</div><div>?</div>`;
      d.onclick = () => onPick(i);
      doorsEl.appendChild(d);
    }

    function setDoor(i, {selected=false, revealed=false, text='?'}){
      const el = doorsEl.children[i];
      el.classList.toggle('selected', selected);
      el.classList.toggle('revealed', revealed);
      el.lastElementChild.textContent = text;
    }

    function onPick(i){
      if (state.finished || state.picked !== null) return;

      state.picked = i;
      state.carDoor = i; // rigged

      for (let k=0;k<3;k++) setDoor(k, { selected:k===i, revealed:false, text:'?' });

      const candidates = [0,1,2].filter(x => x !== state.picked && x !== state.carDoor);
      state.revealed = candidates[Math.floor(Math.random()*candidates.length)];
      setDoor(state.revealed, { selected:false, revealed:true, text:'Goat' });

      stayBtn.style.display = 'inline-block';
      switchBtn.style.display = 'inline-block';

      stayBtn.onclick = () => finish(false);
      switchBtn.onclick = () => finish(true);
    }

    function finish(switched){
      if (state.finished) return;
      state.finished = true;

      let finalPick = state.picked;
      if (switched){
        finalPick = [0,1,2].find(x => x !== state.picked && x !== state.revealed);
      }

      for (let k=0;k<3;k++){
        if (k === state.revealed) continue;
        const isCar = (k === state.carDoor);
        setDoor(k, { selected:k===finalPick, revealed:true, text: isCar ? 'Car' : 'Goat' });
      }

      const won = (finalPick === state.carDoor);

      stayBtn.style.display = 'none';
      switchBtn.style.display = 'none';

      if (won){
        nextBtn.style.display = 'inline-block';
        nextBtn.onclick = () => show('p4');
      } else {
        retryBtn.style.display = 'inline-block';
        retryBtn.onclick = () => initMonty();

        goatLosses += 1;
        if (goatLosses >= 3) { hardReset(); return; }
        updateGoatUI();
      }
    }
  }

  /* ===== Puzzle 4: Crossword ===== */
  const cwGrid = [
    ['R','X','A','X','I'],
    ['E','J','E','C','T'],
    ['C','A','M','A','N'],
    ['U','M','M','N','O'],
    ['R','E','S','E','T'],
  ];
  const cwBlacks = new Set(['0,1','0,3']);
  const cwNumbers = {
    '0,0': 1,'0,2': 2,'0,4': 3,
    '1,0': 4,'1,1': 5,'1,3': 6,
    '2,0': 7,'3,0': 8,'4,0': 9
  };

  function initCrossword(){
    const table = document.getElementById('cwTable');
    const checkBtn = document.getElementById('cwCheck');
    const hahaText = document.getElementById('cwHaha');
    const nextBtn = document.getElementById('p4Next');
    nextBtn.style.display = 'none';

    checkBtn.style.display = 'inline-block';
    checkBtn.disabled = false;
    hahaText.classList.remove('show');

    table.innerHTML = '';

    for (let r=0;r<5;r++){
      const tr = document.createElement('tr');
      for (let c=0;c<5;c++){
        const td = document.createElement('td');
        const key = `${r},${c}`;

        if (cwNumbers[key]){
          const n = document.createElement('div');
          n.className = 'cw-num';
          n.textContent = cwNumbers[key];
          td.appendChild(n);
        }

        if (cwBlacks.has(key)){
          td.classList.add('black');
        } else {
          const inp = document.createElement('input');
          inp.className = 'cw-inp';
          inp.maxLength = 1;
          inp.dataset.r = r;
          inp.dataset.c = c;

          inp.addEventListener('input', () => {
            inp.value = (inp.value || '').slice(0,1).toUpperCase();
          });

          td.appendChild(inp);
        }

        tr.appendChild(td);
      }
      table.appendChild(tr);
    }

    function isCorrect(){
      let ok = true;
      table.querySelectorAll('input.cw-inp').forEach(inp => {
        const r = parseInt(inp.dataset.r,10);
        const c = parseInt(inp.dataset.c,10);
        const expected = cwGrid[r][c];
        const v = (inp.value || '').toUpperCase();
        if (v !== expected) ok = false;
      });
      return ok;
    }

    function playHahaThen(callback){
      checkBtn.style.display = 'none';
      hahaText.classList.add('show');

      const s = document.getElementById('hahaSound');
      let finished = false;

      const done = () => {
        if (finished) return;
        finished = true;
        s.onended = null;
        callback();
      };

      s.onended = done;

      try {
        s.currentTime = 0;
        const p = s.play();
        if (p && typeof p.catch === 'function') {
          p.catch(() => setTimeout(done, 650));
        }
      } catch (e) {
        setTimeout(done, 650);
      }

      setTimeout(done, Math.max(900, (s.duration ? (s.duration * 1000 + 200) : 1200)));
    }

    checkBtn.onclick = () => {
      if (checkBtn.disabled) return;
      checkBtn.disabled = true;

      const ok = isCorrect();

      if (ok){
        show('p5');              // advance straight away when correct
        return;
      }

      playHahaThen(() => {
        hahaText.classList.remove('show');
        checkBtn.style.display = 'inline-block';
        checkBtn.disabled = false;
      });
    };
  }

  /* ===== Puzzle 5: TEST MODE — always succeeds ===== */
  let p5Timer = null;
  function initPrimeFibTime(){
    const clock = document.getElementById('p5Clock');
    const checkBtn = document.getElementById('p5Check');
    const nextBtn = document.getElementById('p5Next');
    nextBtn.style.display = 'none';

    function update(){
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      clock.textContent = `${hh}:${mm}`;
    }
    update();
    if (p5Timer) clearInterval(p5Timer);
    p5Timer = setInterval(update, 1000);

    checkBtn.onclick = () => {
      nextBtn.style.display = 'inline-block';
    };

    nextBtn.onclick = () => show('pw2');
  }

  /* ===== Password 2: FUECOCO ===== */
  (function initPw2(){
    const ids = ['pw2_1','pw2_2','pw2_3','pw2_4','pw2_5','pw2_6','pw2_7'];
    const inputs = ids.map(id => document.getElementById(id));

    inputs.forEach((inp, i) => {
      inp.addEventListener('input', () => {
        inp.value = (inp.value || '').slice(0,1).toUpperCase();
        if (inp.value && i < inputs.length - 1) inputs[i+1].focus();
        check();
      });
      inp.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !inp.value && i > 0) inputs[i-1].focus();
      });
    });

    function check(){
      const code = inputs.map(x => (x.value || '').toUpperCase()).join('');
      if (code === 'FUECOCO'){
        show('final');
      }
    }
  })();
</script>
</body>
</html>
